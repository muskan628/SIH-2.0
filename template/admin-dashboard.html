<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/static/css/common.css">
  <link rel="stylesheet" href="/static/css/admin-dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<!-- Hamburger -->
<div class="hamburger" onclick="toggleSidebar()">☰</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
  <h2>Menu</h2>
  <ul>
    <li><a href="{{ url_for('admin_home') }}">🏠 Home</a></li>
    <li><a href="{{ url_for('mst_exam') }}">📤 Upload Exam</a></li>
    <li><a href="{{ url_for('quiz_exam') }}">📤 Upload Notes</a></li>
    <li><a href="{{ url_for('student_record') }}">🎓 Student Records</a></li>
    <li><a href="{{ url_for('admin_attendance') }}">📋 Attendance</a></li>
    <li><a href="{{ url_for('admin_proctoring') }}">🔒 Proctoring</a></li>
  </ul>
</div>

<!-- Main Content -->
<div class="main">
  <div class="topbar">
    <h1>👋 Welcome, Admin</h1>
    <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
  </div>

  <!-- Admin Stats Cards -->
  <div class="cards">
    <div class="card">
      <h3>📊 Total Students</h3>
      <p id="totalStudents">150</p>
    </div>
    <div class="card">
      <h3>📝 Active Exams</h3>
      <p id="activeExams">8</p>
    </div>
    <div class="card">
      <h3>📋 Forms Submitted</h3>
      <p id="formsSubmitted">45</p>
    </div>
    <div class="card">
      <h3>📈 Attendance Rate</h3>
      <p id="attendanceRate">94%</p>
    </div>
  </div>

  <!-- Admin Profile Card -->
  <div class="admin-card">
    <div class="admin-info">
      <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Admin">
      <div>
        <h2>Mr. John Doe</h2>
        <p>Administrator</p>
        <p>Email: johndoe@school.edu</p>
      </div>
    </div>

    <table>
      <tr><th>Details</th><th>Info</th></tr>
      <tr><td>Department</td><td>Mathematics</td></tr>
      <tr><td>Experience</td><td>8 years</td></tr>
      <tr><td>Last Login</td><td>Today, 9:30 AM</td></tr>
      <tr><td>Status</td><td><span class="status-active">Active</span></td></tr>
    </table>
  </div>

  <!-- Quick Actions -->
  <div class="section">
    <h2>⚡ Quick Actions</h2>
    <div class="cards">
      <div class="card action-card">
        <h3>📂 Upload Assignment</h3>
        <div class="upload-box">
          <input type="file" id="fileInput" class="form-control">
          <button onclick="uploadAssignment()" class="btn">Upload</button>
        </div>
      </div>
      <div class="card action-card">
        <h3>📝 Forms</h3>
        <div class="form-links">
          <a href="{{ url_for('examination_form') }}" class="btn">Examination Form</a>
          <a href="{{ url_for('mentor_form') }}" class="btn">Mentor Form</a>
        </div>
      </div>
    </div>
    
    <div class="card">
      <h3>📋 Recent Assignments</h3>
      <table id="assignmentTable" class="table">
        <tr><th>File Name</th><th>Date Uploaded</th><th>Action</th></tr>
        <tr><td colspan="3">No files uploaded yet</td></tr>
      </table>
    </div>
  </div>

  <!-- Feature Control -->
  <div class="section">
    <h2>🔓 Feature Control</h2>
    <div class="card">
      <h3>Enable/Disable Features for Students</h3>
      <div class="form-row">
        <label class="checkbox-label">
          <input type="checkbox" id="unlockMentor">
          <span>Mentor Form</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="unlockExamForm">
          <span>Examination Form</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="unlockMst">
          <span>MST Exams</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" id="unlockQuiz">
          <span>Quiz Exams</span>
        </label>
      </div>
      <button onclick="saveUnlocks()" class="btn">Save Settings</button>
    </div>
  </div>

  <!-- Exam Creation -->
  <div class="section">
    <h2>📝 Create Exams</h2>
    <div class="cards">
      <!-- MST Exam Card -->
      <div class="card exam-card">
        <h3>📝 Create MST Exam</h3>
        <div class="form-row">
          <input type="text" id="mstTitle" placeholder="MST Title" class="form-control">
          <input type="number" id="mstDuration" placeholder="Duration (minutes)" value="30" class="form-control">
        </div>
        <div id="mstQuestions">
          <h4>Questions:</h4>
          <div class="question-item">
            <input type="text" placeholder="Question 1" class="question-text form-control">
            <div class="form-row">
              <input type="text" placeholder="Option A" class="option form-control">
              <input type="text" placeholder="Option B" class="option form-control">
            </div>
            <div class="form-row">
              <input type="text" placeholder="Option C" class="option form-control">
              <input type="text" placeholder="Option D" class="option form-control">
            </div>
            <select class="correct-answer form-control">
              <option value="A">Correct Answer: A</option>
              <option value="B">Correct Answer: B</option>
              <option value="C">Correct Answer: C</option>
              <option value="D">Correct Answer: D</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <button onclick="addMstQuestion()" class="btn secondary">+ Add Question</button>
          <button onclick="createMst()" class="btn">Create MST</button>
        </div>
      </div>

      <!-- Quiz Exam Card -->
      <div class="card exam-card">
        <h3>📝 Create Quiz</h3>
        <div class="form-row">
          <input type="text" id="quizTitle" placeholder="Quiz Title" class="form-control">
          <input type="number" id="quizDuration" placeholder="Duration (minutes)" value="10" class="form-control">
        </div>
        <div id="quizQuestions">
          <h4>Questions:</h4>
          <div class="question-item">
            <input type="text" placeholder="Question 1" class="question-text form-control">
            <div class="form-row">
              <input type="text" placeholder="Option A" class="option form-control">
              <input type="text" placeholder="Option B" class="option form-control">
            </div>
            <div class="form-row">
              <input type="text" placeholder="Option C" class="option form-control">
              <input type="text" placeholder="Option D" class="option form-control">
            </div>
            <select class="correct-answer form-control">
              <option value="A">Correct Answer: A</option>
              <option value="B">Correct Answer: B</option>
              <option value="C">Correct Answer: C</option>
              <option value="D">Correct Answer: D</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <button onclick="addQuizQuestion()" class="btn secondary">+ Add Question</button>
          <button onclick="createQuiz()" class="btn">Create Quiz</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Exam Management -->
  <div class="section">
    <h2>📚 Exam Management</h2>
    <div class="cards">
      <div class="card">
        <h3>📝 MST Exams</h3>
        <table id="mstList" class="table">
          <tr><th>ID</th><th>Title</th><th>Created</th><th>Actions</th></tr>
        </table>
      </div>
      <div class="card">
        <h3>📝 Quiz Exams</h3>
        <table id="quizList" class="table">
          <tr><th>ID</th><th>Title</th><th>Created</th><th>Actions</th></tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Forms Management -->
  <div class="section">
    <h2>📋 Forms Management</h2>
    <div class="cards">
      <div class="card">
        <h3>📝 View Submitted Forms</h3>
        <div class="form-links">
          <a href="{{ url_for('view_mentor_forms') }}" class="btn">View Mentor Forms</a>
          <a href="{{ url_for('view_examination_forms') }}" class="btn">View Exam Forms</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule & Classes -->
  <div class="section">
    <h2>📅 Schedule & Classes</h2>
    <div class="cards">
      <div class="card">
        <h3>🗓 Weekly Timetable</h3>
        <table class="table">
          <tr><th>Day</th><th>Time</th><th>Class</th><th>Subject</th></tr>
          <tr><td>Monday</td><td>9:00 - 10:00</td><td>10A</td><td>Math</td></tr>
          <tr><td>Monday</td><td>11:00 - 12:00</td><td>10B</td><td>Physics</td></tr>
          <tr><td>Tuesday</td><td>10:00 - 11:00</td><td>10C</td><td>Math</td></tr>
          <tr><td>Wednesday</td><td>12:00 - 1:00</td><td>9A</td><td>Computer Science</td></tr>
        </table>
      </div>
      <div class="card">
        <h3>📘 Subjects & Classes</h3>
        <table class="table">
          <tr><th>Subject</th><th>Class</th><th>Students</th></tr>
          <tr><td>Mathematics</td><td>10A</td><td>32</td></tr>
          <tr><td>Mathematics</td><td>10C</td><td>28</td></tr>
          <tr><td>Physics</td><td>10B</td><td>30</td></tr>
          <tr><td>Computer Science</td><td>9A</td><td>25</td></tr>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
const hamburger = document.querySelector('.hamburger');
const sidebar = document.getElementById('sidebar');

hamburger.addEventListener('click', () => {
    sidebar.classList.toggle('active');
});


async function loadFlags(){
  try{
    const res = await fetch('/api/feature-flags');
    const flags = await res.json();
    document.getElementById('unlockMentor').checked = !!flags.mentor_form;
    document.getElementById('unlockExamForm').checked = !!flags.examination_form;
    document.getElementById('unlockMst').checked = !!flags.mst_exam;
    document.getElementById('unlockQuiz').checked = !!flags.quiz_exam;
  }catch(e){ console.error('Failed to load flags', e); }
}

async function setFlag(key, value){
  await fetch(`/api/feature-flags/${key}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({is_unlocked: !!value})
  });
}

async function saveUnlocks(){
  try{
    await Promise.all([
      setFlag('mentor_form', document.getElementById('unlockMentor').checked),
      setFlag('examination_form', document.getElementById('unlockExamForm').checked),
      setFlag('mst_exam', document.getElementById('unlockMst').checked),
      setFlag('quiz_exam', document.getElementById('unlockQuiz').checked)
    ]);
    alert('Saved');
  }catch(e){ alert('Save failed'); }
}

async function uploadAssignment(){
  const input = document.getElementById('fileInput');
  if(!input.files || !input.files[0]){ alert('Choose a file'); return; }
  const file = input.files[0];
  const payload = {
    title: file.name,
    description: 'Uploaded via dashboard',
    file_url: `/uploads/${file.name}`
  };
  // Note: replace with real upload later; we just record metadata for now
  const res = await fetch('/api/assignments',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(data && data.ok){
    const table = document.getElementById('assignmentTable');
    const row = table.insertRow(-1);
    row.insertCell(0).innerText = file.name;
    row.insertCell(1).innerText = new Date().toISOString().slice(0,10);
    row.insertCell(2).innerHTML = `<a href="${payload.file_url}">View</a>`;
  } else {
    alert('Upload failed');
  }
}

async function loadExams(){
  try{
    const res = await fetch('/api/exams');
    const data = await res.json();
    const mstT = document.getElementById('mstList');
    const quizT = document.getElementById('quizList');
    // clear existing rows except header
    mstT.querySelectorAll('tr:not(:first-child)').forEach(r=>r.remove());
    quizT.querySelectorAll('tr:not(:first-child)').forEach(r=>r.remove());
    (data.mst||[]).forEach(it=>{
      const row = mstT.insertRow(-1);
      row.insertCell(0).innerText = it.id;
      row.insertCell(1).innerText = it.title || '';
      row.insertCell(2).innerText = it.created_at || '';
    });
    (data.quiz||[]).forEach(it=>{
      const row = quizT.insertRow(-1);
      row.insertCell(0).innerText = it.id;
      row.insertCell(1).innerText = it.title || '';
      row.insertCell(2).innerText = it.created_at || '';
    });
  }catch(e){ console.error('Failed to load exams', e); }
}

async function createMst(){
  try{
    const t = document.getElementById('mstTitle').value.trim();
    const duration = parseInt(document.getElementById('mstDuration').value) || 30;
    const questions = collectQuestions('mstQuestions');
    if(questions.length === 0){ alert('Add at least one question'); return; }
    const config = { duration, questions };
    const res = await fetch('/api/exams/mst', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({title:t, config})});
    const data = await res.json();
    if(data && data.ok){ await loadExams(); alert('MST created'); } else { alert('Failed to create MST'); }
  }catch(e){ alert('Failed to create MST'); }
}

async function createQuiz(){
  try{
    const t = document.getElementById('quizTitle').value.trim();
    const duration = parseInt(document.getElementById('quizDuration').value) || 10;
    const questions = collectQuestions('quizQuestions');
    if(questions.length === 0){ alert('Add at least one question'); return; }
    const config = { duration, questions };
    const res = await fetch('/api/exams/quiz', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({title:t, config})});
    const data = await res.json();
    if(data && data.ok){ await loadExams(); alert('Quiz created'); } else { alert('Failed to create Quiz'); }
  }catch(e){ alert('Failed to create Quiz'); }
}

function collectQuestions(containerId){
  const container = document.getElementById(containerId);
  const items = container.querySelectorAll('.question-item');
  const questions = [];
  items.forEach((item, index) => {
    const questionText = item.querySelector('.question-text').value.trim();
    const options = Array.from(item.querySelectorAll('.option')).map(o => o.value.trim()).filter(o => o);
    const correct = item.querySelector('.correct-answer').value;
    if(questionText && options.length >= 2){
      questions.push({
        id: index + 1,
        question: questionText,
        options: options,
        correct: correct
      });
    }
  });
  return questions;
}

function addMstQuestion(){
  addQuestion('mstQuestions');
}

function addQuizQuestion(){
  addQuestion('quizQuestions');
}

function addQuestion(containerId){
  const container = document.getElementById(containerId);
  const count = container.querySelectorAll('.question-item').length + 1;
  const div = document.createElement('div');
  div.className = 'question-item';
  div.innerHTML = `
    <input type="text" placeholder="Question ${count}" class="question-text form-control">
    <div class="form-row">
      <input type="text" placeholder="Option A" class="option form-control">
      <input type="text" placeholder="Option B" class="option form-control">
    </div>
    <div class="form-row">
      <input type="text" placeholder="Option C" class="option form-control">
      <input type="text" placeholder="Option D" class="option form-control">
    </div>
    <select class="correct-answer form-control">
      <option value="A">Correct Answer: A</option>
      <option value="B">Correct Answer: B</option>
      <option value="C">Correct Answer: C</option>
      <option value="D">Correct Answer: D</option>
    </select>
  `;
  container.appendChild(div);
}

document.addEventListener('DOMContentLoaded', ()=>{ loadFlags(); loadExams(); });
</script>

<style>
/* Admin-specific styles */
.admin-card {
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  padding: 20px;
  margin-bottom: 20px;
}

.admin-info {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
}

.admin-info img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  object-fit: cover;
}

.admin-info h2 {
  margin: 0;
  color: var(--brand);
}

.admin-info p {
  margin: 5px 0;
  color: var(--muted);
}

.status-active {
  background: #10b981;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.action-card {
  min-height: 200px;
}

.exam-card {
  min-height: 400px;
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 8px;
  border-radius: 6px;
  transition: background 0.2s;
}

.checkbox-label:hover {
  background: #f3f4f6;
}

.checkbox-label input[type="checkbox"] {
  margin: 0;
}

.form-links {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.question-item {
  margin-bottom: 20px;
  padding: 15px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: #f9fafb;
}

.question-item h4 {
  margin: 0 0 10px 0;
  color: var(--brand);
}

/* Responsive improvements */
@media (max-width: 768px) {
  .admin-info {
    flex-direction: column;
    text-align: center;
  }
  
  .form-links {
    flex-direction: column;
  }
  
  .exam-card {
    min-height: auto;
  }
}
</style>

</body>
</html>
